<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>vim代码阅读</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Coding Coding </a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/vim.html">vim</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/.html" rel="bookmark"
           title="Permalink to vim代码阅读">vim代码阅读</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-07-13T00:00:00">
                Published: Sun 13 July 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/zhangjoto.html">zhangjoto</a>
        </address>
<p>In <a href="/category/vim.html">vim</a>. </p>
<p>tags: <a href="/tag/vim.html">vim</a> </p>Translations:
        <a href="/-.html"></a>

</footer><!-- /.post-info -->      <div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#ctags" id="id5">ctags</a><ul>
<li><a class="reference internal" href="#tag" id="id6">tag文件生成</a></li>
<li><a class="reference internal" href="#id1" id="id7">vim中的使用方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cscope" id="id8">cscope</a><ul>
<li><a class="reference internal" href="#id2" id="id9">建立数据库</a></li>
<li><a class="reference internal" href="#id3" id="id10">vim中的使用方法</a></li>
<li><a class="reference internal" href="#cscopectags" id="id11">同时使用cscope与ctags</a><ul>
<li><a class="reference internal" href="#id4" id="id12">限制</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#taglist" id="id13">taglist</a></li>
</ul>
</div>
<div class="section" id="ctags">
<h2><a class="toc-backref" href="#id5">ctags</a></h2>
<p>为源代码生成tag文件，指明变量、宏、函数等元素的定义和代码位置等，阅读代码的过程
中可以利用tag文件快速在引用和定义之间跳转。支持的语言不仅有C，还包括了
Awk/Cobol/Java/Make/Perl/Python/Sh/SQL/Tcl等语言，其完整列表可使用以下命令获得：</p>
<div class="highlight"><pre>ctags --list-languages
</pre></div>
<div class="section" id="tag">
<h3><a class="toc-backref" href="#id6">tag文件生成</a></h3>
<p>常用选项包括：</p>
<table border="1" class="docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<tbody valign="top">
<tr><td>选项</td>
<td>含义</td>
</tr>
<tr><td>-a</td>
<td>等同于--append</td>
</tr>
<tr><td>-f</td>
<td>指定生成的tagfile文件名</td>
</tr>
<tr><td>-h</td>
<td>将指定的文件扩展名识别为头文件，以逗号分隔</td>
</tr>
<tr><td>-L</td>
<td>从指定文件中读入需要生成tag的文件名列表</td>
</tr>
<tr><td>-R</td>
<td>等同于--recurse</td>
</tr>
<tr><td>--langmap=</td>
<td>控制文件名与程序语言的映射，格式为语言名:[+]文件扩展名或文件名模
式的列表，+表示追加</td>
</tr>
</tbody>
</table>
<p>各选项的详细说明参见&quot;Exuberant Ctags中文手册&quot;</p>
<p>实际使用示例：</p>
<div class="highlight"><pre>ctags -R --langmap<span class="o">=</span>c:+.pc.ec.sqc --exclude<span class="o">=</span>tmp
</pre></div>
<p>即可将.pc/.ec/.sqc识别为C的源代码文件，并为当前目录下的所有C代码生成tag，同时排
除tmp目录中的文件。</p>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id7">vim中的使用方法</a></h3>
<p>首先在.vimrc中指定tag文件的位置（默认只会在当前目录查找tag文件）</p>
<div class="highlight"><pre><span class="k">set</span> <span class="k">tags</span><span class="p">=~</span><span class="sr">/src/</span><span class="k">tags</span><span class="p">,~</span><span class="sr">/public/</span><span class="k">tags</span>
</pre></div>
<p>相关的基本命令和快捷键如下：</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="14%" />
<col width="68%" />
</colgroup>
<tbody valign="top">
<tr><td>命令/快捷键</td>
<td>助记</td>
<td>功能</td>
</tr>
<tr><td>Ctrl-]</td>
<td>&nbsp;</td>
<td>跳转到与光标所在单词匹配的第一个tag</td>
</tr>
<tr><td>g]</td>
<td>global ]</td>
<td>搜索所有与光标所在单词匹配的tag，并列出供选择(vi无
此功能)</td>
</tr>
<tr><td>Ctrl-t</td>
<td>&nbsp;</td>
<td>返回</td>
</tr>
<tr><td>:ts [ident]</td>
<td>tags select</td>
<td>列出与ident匹配的所有tag，ident未指定则使用当前值(vi
无此功能)</td>
</tr>
<tr><td>:ta {ident}</td>
<td>tag</td>
<td>跳转到指定tag，当记不住tag全名时，以/pattern的方式使
用正则会跳转到第一个匹配，配合:ts使用即可</td>
</tr>
<tr><td>:tj [ident]</td>
<td>tag jump</td>
<td>只有一个匹配时效果同:ta，有多个匹配时效果同:ts(vi无
此功能)</td>
</tr>
<tr><td>:tn</td>
<td>tag next</td>
<td>跳转到下一个匹配(vi无此功能)</td>
</tr>
<tr><td>:tp</td>
<td>tag prev</td>
<td>跳转到上一个匹配(vi无此功能)</td>
</tr>
<tr><td>:tags</td>
<td>&nbsp;</td>
<td>显示tag栈</td>
</tr>
<tr><td>vim -t {ident}</td>
<td>&nbsp;</td>
<td>打开vim并直接跳到指定tag，与:ta一样可以使用正则，不
过实际传递给vim的ident会受shell解析的影响</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="cscope">
<h2><a class="toc-backref" href="#id8">cscope</a></h2>
<p>这部分内容主要参考易水博客和vim中文手册&quot;help cscope&quot;节整理，尤其是vim中文手册，
强烈建议多看看。</p>
<ul class="simple">
<li><a class="reference external" href="http://easwy.com/blog/archives/advanced-vim-skills-cscope/">http://easwy.com/blog/archives/advanced-vim-skills-cscope/</a></li>
<li><a class="reference external" href="http://vimcdoc.sourceforge.net/doc/if_cscop.html">http://vimcdoc.sourceforge.net/doc/if_cscop.html</a></li>
</ul>
<p>cscope功能上比ctags更强，不过它在默认情况下仅对C/lex/yacc类型的文件进行处理，想
在其它语言的项目中使用它还要用到一点技巧。</p>
<p>cscope被设计来回答以下几个问题：</p>
<ul class="simple">
<li>什么地方用到了这个符号？</li>
<li>这是在什么地方定义的？</li>
<li>这个变量在哪里被赋值？</li>
<li>这个全局符号的定义在哪里？</li>
<li>这个函数在源文件中的哪个地方？</li>
<li>哪些函数调用了这个函数？</li>
<li>这个函数调用了哪些函数？</li>
<li>信息 &quot;out of space&quot; 从哪来？</li>
<li>这个源文件在整个目录结构中处于什么位置？</li>
<li>哪些文件包含这个头文件？</li>
</ul>
<p>cscope在第一次被使用在指定的源文件时会建立一个符号的数据库。接下来调用时，
cscope仅仅重建那些被改动或者和新文件相关的数据库。那些没有被改动的文件相关的数
据库会被直接复制使用。这使得重建数据库要比第一次运行快许多。</p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id9">建立数据库</a></h3>
<p>其常用选项包括：</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="92%" />
</colgroup>
<tbody valign="top">
<tr><td>选项</td>
<td>含义</td>
</tr>
<tr><td>-R</td>
<td>在生成索引文件时，搜索子目录树中的代码</td>
</tr>
<tr><td>-b</td>
<td>只生成索引文件，不进入cscope的界面</td>
</tr>
<tr><td>-q</td>
<td>生成cscope.in.out和cscope.po.out文件，加快cscope的索引速度</td>
</tr>
<tr><td>-k</td>
<td>在生成索引文件时，不搜索/usr/include目录</td>
</tr>
<tr><td>-i</td>
<td>为cscope指定源文件列表(默认为当前目录的cscope.files)，可以使用&quot;-&quot;， 表示
由标准输入获得文件列表</td>
</tr>
<tr><td>-Idir</td>
<td>在-I选项指出的目录中查找头文件</td>
</tr>
<tr><td>-u</td>
<td>扫描所有文件，重新生成交叉索引文件</td>
</tr>
<tr><td>-C</td>
<td>在搜索时忽略大小写</td>
</tr>
<tr><td>-Ppath</td>
<td>在以相对路径表示的文件前加上的path，这样，你不用切换到你数据库文件所在的
目录也可以使用它了</td>
</tr>
</tbody>
</table>
<p>常见的使用方式有两种，如果需要使用源文件列表：</p>
<div class="highlight"><pre>find . -name <span class="s2">&quot;*.h&quot;</span> -o -name <span class="s2">&quot;*.c&quot;</span> -o -name <span class="s2">&quot;*.cc&quot;</span> &gt; cscope.files
cscope -bkq
</pre></div>
<p>否则：</p>
<div class="highlight"><pre>cscope -Rqkb
</pre></div>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id10">vim中的使用方法</a></h3>
<p>我们首先利用vim中的help看看使用cscope相关的命令有哪些：</p>
<div class="highlight"><pre><span class="p">:</span><span class="k">cs</span> help
<span class="k">cscope</span> commands:
add  : Add <span class="k">a</span> <span class="k">new</span> database             <span class="p">(</span>Usage: add <span class="k">file</span><span class="p">|</span><span class="nb">dir</span> [<span class="k">pre</span><span class="p">-</span><span class="nb">path</span>] [flags]<span class="p">)</span>
find : Query <span class="k">for</span> <span class="k">a</span> pattern            <span class="p">(</span>Usage: find <span class="k">c</span><span class="p">|</span><span class="k">d</span><span class="p">|</span><span class="k">e</span><span class="p">|</span><span class="k">f</span><span class="p">|</span><span class="k">g</span><span class="p">|</span><span class="k">i</span><span class="p">|</span><span class="k">s</span><span class="p">|</span><span class="k">t</span> name<span class="p">)</span>
       <span class="k">c</span>: Find functions calling this <span class="k">function</span>
       <span class="k">d</span>: Find functions called by this <span class="k">function</span>
       <span class="k">e</span>: Find this egrep pattern
       <span class="k">f</span>: Find this <span class="k">file</span>
       <span class="k">g</span>: Find this definition
       <span class="k">i</span>: Find <span class="k">files</span> #including this <span class="k">file</span>
       <span class="k">s</span>: Find this C symbol
       <span class="k">t</span>: Find this text string
help : Show this message              <span class="p">(</span>Usage: help<span class="p">)</span>
kill : Kill <span class="k">a</span> connection              <span class="p">(</span>Usage: kill #<span class="p">)</span>
reset: Reinit <span class="k">all</span> connections         <span class="p">(</span>Usage: reset<span class="p">)</span>
show : Show connections               <span class="p">(</span>Usage: show<span class="p">)</span>
</pre></div>
<p>对命令做一点小小的解释：</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="5%" />
<col width="87%" />
</colgroup>
<tbody valign="top">
<tr><td>命令</td>
<td>简写</td>
<td>解释</td>
</tr>
<tr><td>add</td>
<td>a</td>
<td>添加一个数据库并连接，pre-path指定数据库中文件名的目录前缀，flags
不详，似乎为可调用的外部命令</td>
</tr>
<tr><td>find</td>
<td>f</td>
<td>cs的最主要功能，以各种方式查询数据库，具体选项在后面会有详细一点的
解释</td>
</tr>
<tr><td>help</td>
<td>h</td>
<td>显示cs命令的简单帮助</td>
</tr>
<tr><td>kill</td>
<td>k</td>
<td>关闭一个数据库连接</td>
</tr>
<tr><td>reset</td>
<td>r</td>
<td>重新初始化所有数据库连接</td>
</tr>
<tr><td>show</td>
<td>s</td>
<td>显示所有数据库连接</td>
</tr>
</tbody>
</table>
<p>在vim中使用cscope提供的功能，要先用add命令包含cscope数据库。</p>
<p>注:当vim的工作目录不在cscope.out的所在目录，而且生成数据库没有使用绝对路径，则
cs add时必须指定pre-path</p>
<p>然后就可以查找了，vim支持以下几种cscope的查询功能：</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="93%" />
</colgroup>
<tbody valign="top">
<tr><td>类型</td>
<td>含义</td>
</tr>
<tr><td>s</td>
<td>查找C语言符号，即查找函数名、宏、枚举值等出现的地方</td>
</tr>
<tr><td>g</td>
<td>查找函数、宏、枚举等定义的位置，类似ctags所提供的功能</td>
</tr>
<tr><td>d</td>
<td>查找本函数调用的函数</td>
</tr>
<tr><td>c</td>
<td>查找调用本函数的函数</td>
</tr>
<tr><td>t</td>
<td>查找指定的字符串</td>
</tr>
<tr><td>e</td>
<td>查找egrep模式，相当于egrep功能，但查找速度快多了</td>
</tr>
<tr><td>f</td>
<td>查找并打开文件，类似vim的find功能</td>
</tr>
<tr><td>i</td>
<td>查找包含本文件的文件</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cscopectags">
<h3><a class="toc-backref" href="#id11">同时使用cscope与ctags</a></h3>
<p>有两个vim选项可以使vim同时使用cscope和ctags</p>
<table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<tbody valign="top">
<tr><td>选项</td>
<td>含义</td>
</tr>
<tr><td>cst</td>
<td>设定后使得:tag/Ctrl-]/vim -t都会使用:cstag而非:tag，即同时搜索cscope数据
库与标签文件</td>
</tr>
<tr><td>csto</td>
<td>指定:cstag命令查找的次序，默认值为0，此时cscope数据库优先，设为1则与此相
反</td>
</tr>
</tbody>
</table>
<p>给一个小小的示例吧，在vim中尝试一下这些ex命令：</p>
<div class="highlight"><pre><span class="p">:</span><span class="k">set</span> <span class="nb">cst</span>
<span class="p">:</span><span class="k">set</span> <span class="nb">nocst</span>
<span class="p">:</span><span class="k">set</span> <span class="nb">csto</span><span class="p">=</span><span class="m">0</span>
<span class="p">:</span><span class="k">set</span> <span class="nb">csto</span><span class="p">=</span><span class="m">1</span>
</pre></div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id12">限制</a></h4>
<ul class="simple">
<li>vim对cscope的集成方式与ctags有所不同，我们在vim中使用cs add命令时，vim是通过
fork()/execl()调起一个cscope进程读取相应的数据库，并通过pipe()与其通信发送指令
并接受结果（在此我们可以理解为何在add一个数据库后，显示为一个connect）。因此，
我们基本上只有在类unix系统上才可以使用cscope。</li>
<li>:cstag命令实际上只会调用:tj而非:tag</li>
<li>cscope数据库默认维护的是文件的相对路径，因此进入vim时的工作目录会影响查询后的
跳转是否成功。目前找到的解决方法有二：<ul>
<li>生成cscope.out时使用cscope.files，且其中指定的源文件列表均采用绝对路径；</li>
<li>cs add时指定pre-path；</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="taglist">
<h2><a class="toc-backref" href="#id13">taglist</a></h2>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>