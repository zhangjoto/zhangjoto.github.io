<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>Coding Coding - kvm virt</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Coding Coding </a></h1>
                <nav><ul>
                    <li><a href="/category/kvm.html">kvm</a></li>
                    <li><a href="/category/tuxedo.html">tuxedo</a></li>
                    <li><a href="/category/vim.html">vim</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/xu-ni-hua.html">虚拟化</a></h1>
<footer class="post-info">
        <abbr class="published" title="2014-07-14T00:00:00">
                Published: Mon 14 July 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/zhangjoto.html">zhangjoto</a>
        </address>
<p>In <a href="/category/kvm.html">kvm</a>. </p>
<p>tags: <a href="/tag/kvm-virt.html">kvm virt</a> </p>
</footer><!-- /.post-info --><div class="section" id="kvmdocker">
<h2>将kvm镜像转为docker镜像</h2>
<div class="section" id="kvm">
<h3>kvm镜像挂载</h3>
<p>如果kvm镜像是使用raw格式或者物理分区/lvm，使用如下方式：</p>
<div class="highlight"><pre>losetup -f
</pre></div>
<p>得到可用的loop设备(loop0)</p>
<div class="highlight"><pre>losetup /dev/loop0 /dev/vgroot/lvmini
fdisk -l /dev/loop0

Device       Boot     Start       End  Blocks  Id System
/dev/loop0p1 *         2048    165887   81920  83 Linux
/dev/loop0p2         165888  16777215 8305664  8e Linux LVM

losetup /dev/loop1 /dev/vgroot/lvmini -o 84934656 <span class="o">(</span>165888 * 512<span class="o">)</span>
pvscan
</pre></div>
<p>如果镜像中使用的vg名与物理机上有重名，可先查询uuid，再改名</p>
<pre class="code sh literal-block">
vgs -v
vgrename ....

mount /dev/vgmini/lvroot /media
mount /dev/loop0 /media/boot -o loop,offset<span class="o">=</span>1048576  <span class="o">(</span>2048 * 512<span class="o">)</span>
mount /dev/vgmini/lvhome /media/home
........
</pre>
<p>如果kvm镜像是使用qcow2格式，则需要使用qemu-nbd工具</p>
<pre class="code sh literal-block">
modprobe nbd <span class="nv">max_part</span><span class="o">=</span>63
qemu-nbd -c /dev/nbd0 deb7.img
mount /dev/nbd0p1 /media
........
</pre>
<p>对逻辑卷的处理至此直接vgscan也可以看到了。</p>
</div>
<div class="section" id="id2">
<h3>镜像打包并导入</h3>
<pre class="code sh literal-block">
tar --numeric-owner -c -C /media . | docker import - debian:debian7
</pre>
</div>
<div class="section" id="id3">
<h3>卸载</h3>
<p>按顺序执行</p>
<pre class="code sh literal-block">
umount ...
vgchange -a n
losetup -d
qemu-nbd -d /dev/nbd0
</pre>
</div>
</div>
                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>