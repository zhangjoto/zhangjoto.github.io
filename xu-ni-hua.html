<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>虚拟化</title>
        <link rel="stylesheet" href="http://127.0.0.1:8000/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://127.0.0.1:8000/">Coding Coding </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://127.0.0.1:8000/category/kvm.html">kvm</a></li>
                    <li><a href="http://127.0.0.1:8000/category/tuxedo.html">tuxedo</a></li>
                    <li><a href="http://127.0.0.1:8000/category/vim.html">vim</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://127.0.0.1:8000/xu-ni-hua.html" rel="bookmark"
           title="Permalink to 虚拟化">虚拟化</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-07-14T00:00:00">
                Published: Mon 14 July 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://127.0.0.1:8000/author/zhangjoto.html">zhangjoto</a>
        </address>
<p>In <a href="http://127.0.0.1:8000/category/kvm.html">kvm</a>. </p>
<p>tags: <a href="http://127.0.0.1:8000/tag/kvm.html">kvm</a> <a href="http://127.0.0.1:8000/tag/virt.html">virt</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="kvmdocker">
<h2>将kvm镜像转为docker镜像</h2>
<div class="section" id="kvm">
<h3>kvm镜像挂载</h3>
<p>如果kvm镜像是使用raw格式或者物理分区/lvm，使用如下方式：</p>
<div class="highlight"><pre><span class="go">losetup -f</span>
</pre></div>
<p>得到可用的loop设备(loop0)</p>
<div class="highlight"><pre><span class="go">losetup /dev/loop0 /dev/vgroot/lvmini</span>
<span class="go">fdisk -l /dev/loop0</span>

<span class="go">Device       Boot     Start       End  Blocks  Id System</span>
<span class="go">/dev/loop0p1 *         2048    165887   81920  83 Linux</span>
<span class="go">/dev/loop0p2         165888  16777215 8305664  8e Linux LVM</span>

<span class="go">losetup /dev/loop1 /dev/vgroot/lvmini -o 84934656 (165888 * 512)</span>
<span class="go">pvscan</span>
</pre></div>
<p>如果镜像中使用的vg名与物理机上有重名，可先查询uuid，再改名</p>
<pre class="code console literal-block">
<span class="go">vgs -v
vgrename ....

mount /dev/vgmini/lvroot /media
mount /dev/loop0 /media/boot -o loop,offset=1048576  (2048 * 512)
mount /dev/vgmini/lvhome /media/home
........</span>
</pre>
<p>如果kvm镜像是使用qcow2格式，则需要使用qemu-nbd工具</p>
<pre class="code console literal-block">
<span class="go">modprobe nbd max_part=63
qemu-nbd -c /dev/nbd0 deb7.img
mount /dev/nbd0p1 /media
........</span>
</pre>
<p>对逻辑卷的处理至此直接vgscan也可以看到了。</p>
</div>
<div class="section" id="id2">
<h3>镜像打包并导入</h3>
<pre class="code console literal-block">
<span class="go">tar --numeric-owner -c -C /media . | docker import - debian:debian7</span>
</pre>
</div>
<div class="section" id="id3">
<h3>卸载</h3>
<p>按顺序执行</p>
<pre class="code console literal-block">
<span class="go">umount ...
vgchange -a n
losetup -d
qemu-nbd -d /dev/nbd0</span>
</pre>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>